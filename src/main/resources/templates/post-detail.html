<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>PETTY ê²Œì‹œê¸€ ìƒì„¸</title>
    <style>
        body {
          font-family: Arial, sans-serif;
          background-color: #f9f9f9;
          padding: 20px;
        }
        .meta {
          font-size: 0.9rem;
          color: #555;
          margin: 10px 0;
          display: flex;
          gap: 12px;
        }
        .badge {
          display: inline-block;
          background-color: #ffc107;
          color: #fff;
          font-size: 0.75rem;
          padding: 4px 8px;
          border-radius: 4px;
          margin-bottom: 8px;
        }
        .action-buttons {
          margin-top: 20px;
        }
        .comment-box {
          margin-top: 40px;
        }
        .comment {
          background: #fff;
          padding: 10px;
          margin-bottom: 10px;
          border-radius: 6px;
          box-shadow: 0 0 4px rgba(0,0,0,0.1);
        }
        textarea {
          width: 100%;
          padding: 8px;
          margin-top: 10px;
        }
        button {
          margin-top: 8px;
          padding: 6px 12px;
          background-color: #ffc107;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          color: white;
        }
        img {
          max-width: 100%;
          border-radius: 6px;
          margin-top: 10px;
        }
    </style>
</head>
<body>

<main>
    <div id="postDetail">ë¡œë”© ì¤‘...</div>
</main>

<!-- âœ… ìœ ë¯¸ë‹˜ì˜ ì „ì²´ JS ì½”ë“œ -->
<script>
    const postId = new URLSearchParams(location.search).get("id");

    async function fetchPostDetail() {
      try {
        const res = await fetch(`/api/posts/${postId}`);
        if (!res.ok) throw new Error("ê²Œì‹œê¸€ ì¡°íšŒ ì‹¤íŒ¨");

        const post = await res.json();
        const container = document.getElementById("postDetail");
        const isLoggedIn = !!localStorage.getItem("jwt");
        const imageHtml = Array.isArray(post.images) && post.images.length > 0
          ? post.images
              .sort((a, b) => a.ordering - b.ordering)  // ìˆœì„œ ë³´ì¥
              .map(img => `<img src="${img.imageUrl}" alt="ì´ë¯¸ì§€">`)
              .join('')
          : '';

          const likeButtonHtml = isLoggedIn
            ? `<button id="likeBtn">â¤ï¸ ì¢‹ì•„ìš”</button>`
            : '';

        container.innerHTML = `
          <div class="badge">${post.petType || ''}</div>
          <h1>${post.title}</h1>
          <div class="meta">
            <span>ğŸ‘¤ ${post.writer}</span>
            <span>${new Date(post.createdAt).toLocaleDateString()}</span>
            <span id="likeCount">â¤ï¸ ${post.likeCount || 0}</span>
            <span>ğŸ’¬ ${post.commentCount}</span>
          </div>
          ${likeButtonHtml}
          ${imageHtml}
          <p>${post.content?.replaceAll('\n', '<br>')}</p>
          ${post.region ? `<p><strong>ì—¬í–‰ ì¥ì†Œ:</strong> ${post.region}</p>` : ''}
          ${post.petName ? `<p><strong>ë°˜ë ¤ë™ë¬¼ ì´ë¦„:</strong> ${post.petName}</p>` : ''}
          ${post.postType === "QNA" ? `<p><strong>ì§ˆë¬¸ ìƒíƒœ:</strong> ${post.isResolved ? 'í•´ê²°ë¨' : 'ë¯¸í•´ê²°'}</p>` : ''}
          ${isLoggedIn ? `
          <div class="action-buttons">
            <button onclick="goToEditPage('${post.postType}', ${postId})">âœï¸ ìˆ˜ì •</button>
            <button onclick="deletePost()">ğŸ—‘ ì‚­ì œ</button>
          </div>` : ''}
          <div class="comment-box">
            <h3>ëŒ“ê¸€</h3>
            <div id="commentList"></div>
            <form id="commentForm">
              <textarea id="commentContent" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required></textarea>
              <button type="submit">ë“±ë¡</button>
            </form>
          </div>
        `;

        if (isLoggedIn) {
        const likeBtn = document.getElementById("likeBtn");
        likeBtn?.addEventListener("click", async () => {
          try {
            const res = await fetch(`/api/posts/${postId}/like`, {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("jwt")
              }
            });

            if (!res.ok) throw new Error("ì¢‹ì•„ìš” ì‹¤íŒ¨");

            const result = await res.json();
            document.getElementById("likeCount").innerText = `â¤ï¸ ${result.likeCount}`;
          } catch (err) {
            alert("ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            console.error(err);
          }
        });
      }

        bindCommentForm();
        await loadComments();
      } catch (err) {
        console.error(err);
        alert("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    }

    function goToEditPage(postType, postId) {
      const lowerType = postType.toLowerCase(); // QNA â†’ qna
      location.href = `/posts/${lowerType}/edit?id=${postId}`;
    }

    function bindCommentForm() {
      const form = document.getElementById("commentForm");
      form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const content = document.getElementById("commentContent").value;

        try {
          const res = await fetch(`/api/posts/${postId}/comments`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + localStorage.getItem("jwt")
            },
            body: JSON.stringify({ content })
          });

          if (!res.ok) throw new Error("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");

          document.getElementById("commentContent").value = "";
          loadComments();
        } catch (err) {
          alert("ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
      });
    }

    async function loadComments() {
      try {
        const res = await fetch(`/api/posts/${postId}/comments`);
        if (!res.ok) throw new Error("ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

        const comments = await res.json();
        if (!Array.isArray(comments)) return;

        const commentList = document.getElementById("commentList");
        commentList.innerHTML = "";

        comments.forEach(comment => {
          const div = document.createElement("div");
          div.className = "comment";
          div.innerHTML = `
            <p><strong>${comment.writer}</strong> Â· ${new Date(comment.createdAt).toLocaleString()}</p>
            <p id="content-${comment.id}">${comment.content}</p>
            ${localStorage.getItem("jwt") ? `
              <button onclick="editComment(${comment.id}, '${comment.content.replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
              <button onclick="deleteComment(${comment.id})">ì‚­ì œ</button>` : ''}
          `;
          commentList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
      }
    }

    function editComment(commentId, oldContent) {
      const contentElement = document.getElementById(`content-${commentId}`);
      contentElement.innerHTML = `
        <textarea id="edit-input-${commentId}" rows="2">${oldContent}</textarea>
        <button onclick="submitEdit(${commentId})">ì™„ë£Œ</button>
        <button onclick="loadComments()">ì·¨ì†Œ</button>
      `;

      // âœ… commentDiv ë‚´ë¶€ì˜ ê¸°ì¡´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
      const commentDiv = contentElement.closest(".comment");
      const buttons = commentDiv.querySelectorAll("button");
      buttons.forEach(btn => {
        const text = btn.textContent.trim();
        if (text === "ìˆ˜ì •" || text === "ì‚­ì œ") {
          btn.style.display = "none";
        }
      });
    }


    async function submitEdit(commentId) {
      const newContent = document.getElementById(`edit-input-${commentId}`).value;

      if (!newContent) {
        alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      try {
        const res = await fetch(`/api/comments/${commentId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem("jwt")
          },
          body: JSON.stringify({ content: newContent })
        });

        if (!res.ok) {
          const text = await res.text();
          console.error("âŒ ìˆ˜ì • ì‹¤íŒ¨ ì‘ë‹µ:", text);
          alert("ìˆ˜ì • ì‹¤íŒ¨. ë³¸ì¸ ëŒ“ê¸€ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }

        console.log("âœ… ìˆ˜ì • ì™„ë£Œ, ë‚´ìš©:", newContent);

        await loadComments();
      } catch (err) {
        alert("ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }
    }

    async function deletePost() {
      if (!confirm("ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      const res = await fetch(`/api/posts/${postId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem("jwt")
        }
      });

      if (res.ok) {
        alert("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.href = "/";
      } else {
        alert("ì‚­ì œ ì‹¤íŒ¨. ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
      }
    }

    async function deleteComment(commentId) {
      if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      const res = await fetch(`/api/comments/${commentId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem("jwt")
        }
      });

      if (res.ok) {
        loadComments();
      } else {
        alert("ì‚­ì œ ì‹¤íŒ¨. ë³¸ì¸ ëŒ“ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await fetchPostDetail();
      await loadComments();
    });
</script>

</body>
</html>
