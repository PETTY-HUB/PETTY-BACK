<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/defaultLayout}">
<head>
    <title>PETTY - ë°˜ë ¤ë™ë¬¼ ë³´ê³ ì„œ</title>
    <th:block layout:fragment="css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
        <link rel="stylesheet" th:href="@{/css/bootstrap-overrides.css}"/>
        <style>
            @media (min-width: 1400px) {
                .vision-container-custom { max-width: 1296px; }
            }
            .alert-info {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white; border: none; border-radius: var(--border-radius-lg);
            }
            .alert-warning {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white; border: none; border-radius: var(--border-radius-lg);
            }
            #imagePreview img { max-height: 200px; object-fit: contain; }
            .loading-pulse { animation: pulse 2s infinite; }
            @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
            .spinner-container { padding: 3rem; text-align: center; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .spinner-border { width: 3rem; height: 3rem; color: var(--bs-primary); }
            .hidden { opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; }
            .disabled { opacity: 0.6; pointer-events: none; }
        </style>
    </th:block>
</head>
<body>
<th:block layout:fragment="content">
    <div class="container vision-container-custom mt-4">
        <!-- í† í° ìƒíƒœ ì•Œë¦¼ -->
        <div id="tokenAlert" class="alert alert-warning mb-3" style="display: none;">
            <i class="bi bi-shield-exclamation"></i> <span id="tokenMessage">í† í° ìƒíƒœ í™•ì¸ ì¤‘...</span>
        </div>

        <!-- ì˜¤í”„ë¼ì¸ ì•Œë¦¼ -->
        <div id="offlineAlert" class="alert alert-warning mb-3" style="display: none;">
            <i class="bi bi-wifi-off"></i> ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
        </div>

        <!-- ë©”ì¸ í¼ ì˜ì—­ -->
        <div class="p-md-3 p-2 bg-white rounded shadow-sm" id="mainFormContainer">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ -->
                    <div th:if="${username}" class="alert alert-info text-center mb-4">
                        <strong>ğŸ‰ ì•ˆë…•í•˜ì„¸ìš”, <span th:text="${username}"></span>ë‹˜!</strong><br>
                        <span th:if="${canUse}">
                            ì˜¤ëŠ˜ <strong th:text="${remainingUsage}"></strong>íšŒ ë” ë¶„ì„í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            (ì´ <span th:text="${dailyLimit}"></span>íšŒ ì¤‘ <span th:text="${dailyLimit - remainingUsage}"></span>íšŒ ì‚¬ìš©ë¨)
                        </span>
                        <span th:unless="${canUse}" class="text-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            ì˜¤ëŠ˜ì˜ ë¶„ì„ í•œë„(<span th:text="${dailyLimit}"></span>íšŒ)ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.<br>
                            ë‚´ì¼ ë‹¤ì‹œ ì´ìš©í•´ì£¼ì„¸ìš”! ğŸ¾
                        </span>
                    </div>

                    <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ì ì•ˆë‚´ -->
                    <div th:unless="${username}" class="alert alert-warning text-center mb-4">
                        <i class="bi bi-lock"></i>
                        <strong>Vision ë¶„ì„ ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</strong><br>
                        <a href="/login" class="btn btn-primary btn-sm mt-2">ë¡œê·¸ì¸í•˜ê¸°</a>
                    </div>

                    <h3 class="text-center mb-4">ğŸ¾ ë°˜ë ¤ë™ë¬¼ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h3>

                    <!-- ë¶„ì„ í¼ -->
                    <form id="visionForm" th:classappend="${!canUse} ? 'disabled' : ''">
                        <div class="mb-3">
                            <label for="petName" class="form-label">ë°˜ë ¤ë™ë¬¼ ì´ë¦„</label>
                            <input type="text" class="form-control" name="petName" id="petName"
                                   placeholder="ë°˜ë ¤ë™ë¬¼ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                                   th:disabled="${!canUse}" required/>
                        </div>
                        <div class="mb-3">
                            <label for="file" class="form-label">ì´ë¯¸ì§€ ì„ íƒ</label>
                            <input type="file" class="form-control" name="file" id="file"
                                   accept="image/jpeg,image/jpg,image/png"
                                   th:disabled="${!canUse}" required/>
                            <small class="text-muted"> JPEG, PNG í˜•ì‹ë§Œ ì§€ì›í•©ë‹ˆë‹¤ (ìµœëŒ€ 5MB)</small>
                        </div>

                        <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                        <div id="imagePreview" class="mb-3 text-center" style="display: none;">
                            <img id="previewImg" src="" alt="ë¯¸ë¦¬ë³´ê¸°" class="img-fluid rounded"/>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="submitBtn"
                                    th:disabled="${!canUse}">
                                <span th:if="${canUse}">ë¶„ì„í•˜ê¸°</span>
                                <span th:unless="${canUse}">ì‚¬ìš©ëŸ‰ ì´ˆê³¼</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
        <div id="spinnerContainer" class="mt-4 spinner-container" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 loading-pulse"> ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</p>
        </div>

        <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
        <div id="result" class="mt-4" style="display: none;">
            <div class="p-md-3 p-2 bg-white rounded shadow-sm">
                <!-- ë¶„ì„ëœ ì´ë¯¸ì§€ í‘œì‹œ -->
                <div class="mb-3 text-center">
                    <img id="showImg" src="" alt="ë¶„ì„ëœ ì´ë¯¸ì§€" class="img-fluid rounded shadow" style="max-width: 100%"/>
                </div>

                <!-- ì¤‘ê°„ ë³´ê³ ì„œ (ì¢… ë¶„ì„ ê²°ê³¼) -->
                <div id="interim" class="fw-bold alert alert-secondary" style="display: none;"></div>

                <!-- ë¶„ì„ ì¤‘ ë©”ì‹œì§€ -->
                <div id="analyzingMessage" class="text-center text-muted" style="display: none;">
                    <small>ğŸ“ ìƒì„¸í•œ ë³´ê³ ì„œë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...</small>
                </div>

                <!-- ì„±ê³µ ë©”ì‹œì§€ -->
                <div id="successMessage" class="alert alert-success text-center" style="display: none;">
                    âœ¨ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë³´ê³ ì„œ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...
                </div>

                <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
                <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

                <!-- ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
                <div class="text-center mt-4">
                    <a href="/" class="btn btn-outline-secondary">â¬… ëŒì•„ê°€ê¸°</a>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
        // DOM ìš”ì†Œ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
        const form = document.getElementById('visionForm');
        const mainFormContainer = document.getElementById('mainFormContainer');
        const spinnerContainer = document.getElementById('spinnerContainer');
        const result = document.getElementById('result');
        const interim = document.getElementById('interim');
        const analyzingMessage = document.getElementById('analyzingMessage');
        const successMessage = document.getElementById('successMessage');
        const showImg = document.getElementById('showImg');
        const fileInput = document.getElementById('file');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const errorMessage = document.getElementById('errorMessage');
        const offlineAlert = document.getElementById('offlineAlert');
        const tokenAlert = document.getElementById('tokenAlert');
        const tokenMessage = document.getElementById('tokenMessage');

        // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë³€ìˆ˜ë“¤
        const isLoggedIn = /*[[${username != null} ? 'true' : 'false']]*/ 'false';
        const canUse = /*[[${canUse} ? 'true' : 'false']]*/ 'false';
        const remainingUsage = /*[[${remainingUsage}]]*/ 0;

        console.log(' [DEBUG] í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ë¡œê·¸ì¸:', isLoggedIn, 'ì‚¬ìš©ê°€ëŠ¥:', canUse, 'ë‚¨ì€íšŸìˆ˜:', remainingUsage);

        // =============== í† í° ê´€ë¦¬ í•¨ìˆ˜ë“¤ ===============

        /**
         * ìë™ í† í° ê°±ì‹  ê¸°ëŠ¥ì´ í¬í•¨ëœ fetch í•¨ìˆ˜
         */
        async function authenticatedFetch(url, options = {}) {
            try {
                let response = await fetch(url, {
                    ...options,
                    credentials: 'include'
                });

                if (response.status === 401) {
                    console.log(' [TOKEN] 401 ì‘ë‹µ, í† í° ê°±ì‹  ì‹œë„');
                    showTokenAlert('í† í° ê°±ì‹  ì¤‘...', 'warning');

                    const refreshResult = await refreshAccessToken();

                    if (refreshResult.success) {
                        console.log(' [TOKEN] í† í° ê°±ì‹  ì„±ê³µ, ìš”ì²­ ì¬ì‹œë„');
                        hideTokenAlert();

                        response = await fetch(url, {
                            ...options,
                            credentials: 'include'
                        });
                    } else {
                        console.log(' [TOKEN] í† í° ê°±ì‹  ì‹¤íŒ¨');
                        showTokenAlert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'danger');

                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);

                        throw new Error('Authentication failed');
                    }
                }

                return response;
            } catch (error) {
                console.error(' [TOKEN] ì¸ì¦ëœ ìš”ì²­ ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        /**
         * ì•¡ì„¸ìŠ¤ í† í° ê°±ì‹  í•¨ìˆ˜
         */
        async function refreshAccessToken() {
            try {
                console.log(' [TOKEN] ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ì•¡ì„¸ìŠ¤ í† í° ê°±ì‹  ì‹œë„');

                const response = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(' [TOKEN] í† í° ê°±ì‹  ì„±ê³µ:', result.message);
                    return { success: true };
                } else {
                    const error = await response.json();
                    console.log(' [TOKEN] í† í° ê°±ì‹  ì‹¤íŒ¨:', error.error);
                    return { success: false, error: error.error };
                }
            } catch (error) {
                console.error(' [TOKEN] í† í° ê°±ì‹  ì¤‘ ì˜¤ë¥˜:', error);
                return { success: false, error: error.message };
            }
        }

        /**
         * í† í° ìƒíƒœ í™•ì¸ í•¨ìˆ˜
         */
        async function checkTokenStatus() {
            try {
                const response = await fetch('/api/users/me', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const userInfo = await response.json();
                    console.log(' [TOKEN] í˜„ì¬ ì‚¬ìš©ì:', userInfo.username);
                    return { authenticated: true, user: userInfo };
                } else {
                    console.log(' [TOKEN] ì¸ì¦ë˜ì§€ ì•Šì€ ìƒíƒœ');
                    return { authenticated: false };
                }
            } catch (error) {
                console.error(' [TOKEN] í† í° ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                return { authenticated: false };
            }
        }

        /**
         * í† í° ì•Œë¦¼ í‘œì‹œ
         */
        function showTokenAlert(message, type = 'warning') {
            if (tokenAlert && tokenMessage) {
                tokenMessage.textContent = message;
                tokenAlert.className = `alert alert-${type} mb-3`;
                tokenAlert.style.display = 'block';
            }
        }

        /**
         * í† í° ì•Œë¦¼ ìˆ¨ê¹€
         */
        function hideTokenAlert() {
            if (tokenAlert) {
                tokenAlert.style.display = 'none';
            }
        }

        // =============== ì•ˆì „í•œ DOM ì¡°ì‘ í•¨ìˆ˜ë“¤ ===============

        function safeSetDisplay(element, display) {
            if (element && element.style) {
                element.style.display = display;
            }
        }

        function safeSetContent(element, content) {
            if (element) {
                element.textContent = content;
            }
        }

        function safeAddClass(element, className) {
            if (element && element.classList) {
                element.classList.add(className);
            }
        }

        function safeRemoveClass(element, className) {
            if (element && element.classList) {
                element.classList.remove(className);
            }
        }

        // =============== ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ í•¨ìˆ˜ ===============

        function resizeImageIfNeeded(file, minWidth = 200, minHeight = 200) {
            return new Promise((resolve) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                img.onload = function() {
                    console.log(' [DEBUG] ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°:', img.width, 'x', img.height);

                    if (img.width >= minWidth && img.height >= minHeight) {
                        console.log(' [DEBUG] ì´ë¯¸ì§€ í¬ê¸° ì¶©ë¶„í•¨, ì›ë³¸ ì‚¬ìš©');
                        resolve(file);
                        return;
                    }

                    const scale = Math.max(minWidth / img.width, minHeight / img.height);
                    const newWidth = Math.round(img.width * scale);
                    const newHeight = Math.round(img.height * scale);

                    console.log(' [DEBUG] ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ:', newWidth, 'x', newHeight, '(ìŠ¤ì¼€ì¼:', scale, ')');

                    canvas.width = newWidth;
                    canvas.height = newHeight;

                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);

                    canvas.toBlob((blob) => {
                        const resizedFile = new File([blob], file.name, {
                            type: file.type,
                            lastModified: Date.now()
                        });
                        console.log(' [DEBUG] ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ì™„ë£Œ');
                        resolve(resizedFile);
                    }, file.type, 0.9);
                };

                img.onerror = function() {
                    console.error(' [DEBUG] ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, ì›ë³¸ ë°˜í™˜');
                    resolve(file);
                };

                img.src = URL.createObjectURL(file);
            });
        }

        // =============== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ ===============

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        if (fileInput && previewImg && imagePreview) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        safeSetDisplay(imagePreview, 'block');
                    };
                    reader.readAsDataURL(file);
                } else {
                    safeSetDisplay(imagePreview, 'none');
                }
            });
        }

        // ë©”ì¸ í¼ ì œì¶œ ì´ë²¤íŠ¸
        if (form) {
            form.addEventListener('submit', async e => {
                e.preventDefault();
                console.log(' [DEBUG] í¼ ì œì¶œ ì‹œì‘ (í† í° ê°±ì‹  ì§€ì›)');

                // í† í° ìƒíƒœ ì‚¬ì „ í™•ì¸
                const tokenStatus = await checkTokenStatus();
                if (!tokenStatus.authenticated && isLoggedIn === 'true') {
                    console.log(' [DEBUG] í† í° ìƒíƒœ ë¶ˆëŸ‰, ê°±ì‹  ì‹œë„');

                    const refreshResult = await refreshAccessToken();
                    if (!refreshResult.success) {
                        showTokenAlert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'danger');
                        setTimeout(() => window.location.href = '/login', 2000);
                        return;
                    }
                }

                // ì‚¬ìš©ëŸ‰ ì²´í¬
                if (canUse !== 'true') {
                    console.log(' [DEBUG] ì‚¬ìš©ëŸ‰ ì´ˆê³¼');
                    alert('ì˜¤ëŠ˜ì˜ ë¶„ì„ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ì´ìš©í•´ì£¼ì„¸ìš”!');
                    return;
                }

                // ì˜¤í”„ë¼ì¸ ì²´í¬
                if (!navigator.onLine) {
                    console.log(' [DEBUG] ì˜¤í”„ë¼ì¸ ìƒíƒœ');
                    alert('ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    safeSetDisplay(offlineAlert, 'block');
                    return;
                }

                // UI ì´ˆê¸°í™”
                safeSetDisplay(mainFormContainer, 'none');
                safeSetDisplay(spinnerContainer, 'block');
                safeSetDisplay(result, 'none');
                safeSetDisplay(errorMessage, 'none');
                safeSetDisplay(interim, 'none');
                safeRemoveClass(interim, 'hidden');
                safeSetDisplay(analyzingMessage, 'none');
                safeSetDisplay(successMessage, 'none');
                hideTokenAlert();

                // ë¦¬ì‚¬ì´ì¦ˆëœ íŒŒì¼ë¡œ FormData ìƒì„±
                const originalFile = fileInput.files[0];
                if (!originalFile) {
                    alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                console.log(' [DEBUG] ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ í™•ì¸ ì¤‘...');
                const processedFile = await resizeImageIfNeeded(originalFile, 200, 200);

                const fd = new FormData();
                fd.append('file', processedFile);
                fd.append('petName', document.getElementById('petName').value);

                // ì´ë¯¸ì§€ í‘œì‹œ ì¤€ë¹„
                if (showImg) {
                    showImg.src = URL.createObjectURL(processedFile);
                }

                try {
                    console.log(' [DEBUG] ì²« ë²ˆì§¸ ë¶„ì„ í˜¸ì¶œ (ìë™ í† í° ê°±ì‹  í¬í•¨)');

                    const res1 = await authenticatedFetch('/vision/species', {
                        method: 'POST',
                        body: fd
                    });

                    if (!res1.ok) {
                        const errorText = await res1.text();
                        throw new Error(errorText || 'ì¢… ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                    const text1 = await res1.text();
                    console.log(' [DEBUG] /species ì„±ê³µ:', text1);

                    // UI ì—…ë°ì´íŠ¸
                    safeSetContent(interim, text1);
                    safeSetDisplay(interim, 'block');
                    safeSetDisplay(result, 'block');
                    safeSetDisplay(spinnerContainer, 'none');
                    safeSetDisplay(analyzingMessage, 'block');

                } catch (e) {
                    console.error(' [DEBUG] /species ì‹¤íŒ¨:', e);
                    safeSetContent(errorMessage, 'ì²« ë²ˆì§¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
                    safeSetDisplay(errorMessage, 'block');
                    safeSetDisplay(result, 'block');
                    safeSetDisplay(spinnerContainer, 'none');
                    return;
                }

                try {
                    console.log(' [DEBUG] ìµœì¢… ë¶„ì„ í˜¸ì¶œ (ìë™ í† í° ê°±ì‹  í¬í•¨)');

                    const res2 = await authenticatedFetch('/vision/analyze', {
                        method: 'POST',
                        body: fd
                    });

                    if (!res2.ok) {
                        const errorText = await res2.text();

                        if (res2.status === 429) {
                            alert(errorText);
                            window.location.reload();
                            return;
                        }

                        throw new Error(errorText || 'ìµœì¢… ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                    const analysisResult = await res2.text();
                    console.log(' [DEBUG] /analyze ì„±ê³µ, ê²°ê³¼ ê¸¸ì´:', analysisResult.length);

                    // ì¤‘ê°„ ë³´ê³ ì„œë¥¼ ë¶€ë“œëŸ½ê²Œ ìˆ¨ê¸°ê¸°
                    safeAddClass(interim, 'hidden');
                    safeSetDisplay(analyzingMessage, 'none');

                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í›„ í˜ì´ì§€ ì´ë™
                    safeSetDisplay(successMessage, 'block');

                    setTimeout(() => {
                        console.log(' [DEBUG] ë³´ê³ ì„œ í˜ì´ì§€ë¡œ ì´ë™');
                        window.location.href = '/flow/showVisionReport';
                    }, 1500);

                } catch (e) {
                    console.error(' [DEBUG] /analyze ì‹¤íŒ¨:', e);

                    safeSetDisplay(analyzingMessage, 'none');
                    safeAddClass(interim, 'hidden');

                    setTimeout(() => {
                        safeSetDisplay(interim, 'none');
                    }, 300);

                    safeSetContent(errorMessage, 'ìµœì¢… ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
                    safeSetDisplay(errorMessage, 'block');
                }
            });
        }

        // =============== í˜ì´ì§€ ì´ˆê¸°í™” ===============

        // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ê°ì§€
        window.addEventListener('online', () => {
            safeSetDisplay(offlineAlert, 'none');
            console.log(' [DEBUG] ì˜¨ë¼ì¸ ìƒíƒœë¡œ ë³€ê²½');
        });

        window.addEventListener('offline', () => {
            safeSetDisplay(offlineAlert, 'block');
            console.log(' [DEBUG] ì˜¤í”„ë¼ì¸ ìƒíƒœë¡œ ë³€ê²½');
        });

        // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ í† í° í™•ì¸
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && isLoggedIn === 'true') {
                console.log(' [TOKEN] í˜ì´ì§€ í¬ì»¤ìŠ¤ ê°ì§€, í† í° ìƒíƒœ í™•ì¸');
                checkTokenStatus();
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° í† í° ìƒíƒœ í™•ì¸
        if (isLoggedIn === 'true') {
            checkTokenStatus().then(status => {
                if (status.authenticated) {
                    console.log(' [TOKEN] ì´ˆê¸° ì¸ì¦ ìƒíƒœ í™•ì¸ë¨');
                } else {
                    console.log(' [TOKEN] ì´ˆê¸° ì¸ì¦ ìƒíƒœ ì—†ìŒ, í† í° ê°±ì‹  ì‹œë„');
                    refreshAccessToken();
                }
            });
        }

        console.log(' [DEBUG] ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ (í† í° ê°±ì‹  ì§€ì›)');
    </script>
</th:block>
</body>
</html>